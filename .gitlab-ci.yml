image: docker:latest

services:
  - docker:dind  # Docker-in-Docker for builds

variables:
  DOCKER_DRIVER: overlay2
  IMAGE_TAG: registry.gitlab.com/guptalakshya8383/devjourney:$CI_COMMIT_SHORT_SHA
  LATEST_TAG: registry.gitlab.com/guptalakshya8383/devjourney:latest

stages:
  - build
  - push
  - deploy

# ------------------------------------------------
# 1Ô∏è‚É£ BUILD
# ------------------------------------------------
build:
  stage: build
  script:
    - echo "üî® Building Docker image for DevJourney..."
    - docker build -t $IMAGE_TAG .
  only:
    - main

# ------------------------------------------------
# 2Ô∏è‚É£ PUSH TO GITLAB REGISTRY
# ------------------------------------------------
push:
  stage: push
  script:
    - echo "üîê Logging into GitLab Container Registry..."
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - echo "üöÄ Pushing Docker image..."
    - docker push $IMAGE_TAG
    - docker tag $IMAGE_TAG $LATEST_TAG
    - docker push $LATEST_TAG
  only:
    - main
  dependencies:
    - build

# ------------------------------------------------
# 3Ô∏è‚É£ DEPLOY TO RENDER
# ------------------------------------------------
deploy:
  stage: deploy
  image: curlimages/curl:latest
  script:
    - echo "üöÄ Triggering deployment on Render..."
    - curl -X POST "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
        -H "Authorization: Bearer $RENDER_API_KEY" \
        -H "Accept: application/json" \
        -H "Content-Type: application/json"
  only:
    - main
  dependencies:
    - push
  when: on_success

